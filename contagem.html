<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contagem de Estoque</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background-color: #ffc107;
            color: #343a40;
        }
        .table-header {
            background-color: #343a40;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .category-header {
            background-color: #e9ecef;
            font-weight: bold;
            font-size: 1.1em;
        }
        .table-responsive {
            max-height: 80vh;
            overflow-y: auto;
        }
        input[type="text"] {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
        }
        .nav-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .section-title {
            border-left: 5px solid #ffc107;
            padding-left: 10px;
            margin: 20px 0;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .btn-save {
            position: relative;
            overflow: hidden;
        }
        .btn-save .spinner-border {
            width: 1rem;
            height: 1rem;
            display: none;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .input-decimal {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .input-invalido {
            border-color: #dc3545 !important;
            background-color: #f8d7da !important;
        }
    </style>
</head>
<body>
    <!-- Cabeçalho -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand nav-brand" href="#">
                <i class="fas fa-boxes me-2"></i>Controle de Estoque
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="contagem.html"><i class="fas fa-clipboard-list me-1"></i>Contagem</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="registros.html"><i class="fas fa-history me-1"></i>Registros</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html"><i class="fas fa-users-cog me-1"></i>Admin Usuários</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="fazerLogout()"><i class="fas fa-sign-out-alt me-1"></i>Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="section-title">Contagem de Estoque</h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Preencha as quantidades atuais de cada item do estoque. Use ponto ou vírgula para números decimais.
                </div>
                
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Itens do Estoque</h5>
                            <div>
                                <button class="btn btn-success btn-save" onclick="salvarContagem()" id="btnSalvar">
                                    <i class="fas fa-save me-1"></i>Salvar Contagem
                                    <span class="spinner-border spinner-border-sm"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-striped">
                                <thead class="table-header">
                                    <tr>
                                        <th width="70%">Item</th>
                                        <th width="30%">Quantidade</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaContagem">
                                    <!-- Os dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container para notificações -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALbn7ZCTfC7u2otwO2Z1kqp2jMHYPpDQk",
            authDomain: "stock-control-a168b.firebaseapp.com",
            databaseURL: "https://stock-control-a168b-default-rtdb.firebaseio.com",
            projectId: "stock-control-a168b",
            storageBucket: "stock-control-a168b.firebasestorage.app",
            messagingSenderId: "200894157109",
            appId: "1:200894157109:web:119ad5ee8432fb8a7b3c7c"
        };

        // Inicializar Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            console.log('Firebase inicializado com sucesso');
        } catch (error) {
            console.error('Erro ao inicializar Firebase:', error);
        }

        const database = firebase.database();
        const auth = firebase.auth();

        // Estrutura completa de itens
        const categoriasItens = {
            "Chopp": [
                "Heineken", "Amstel", "Baden IPA", "Vinho Tinto", "Vinho Rose", 
                "Brahma", "Tiger"
            ],
            "Longneck": [
                "Heiniken Longneck", "Heiniken Zero", "Eisenbahn", "Patagônia", 
                "Skol Beats", "Smirnoff Ice", "Lagunitas", "Becks", "Corona", 
                "Stella", "Stella Gold", "Sol", "Sol Zero", "Budweiser", 
                "Budweiser Zero", "Spaten"
            ],
            "Soft Drinks": [
                "Coca Cola", "Coca Zero", "Fanta Laranja", "Fanta Uva", 
                "Fanta Guaraná", "Schweppes Citrus", "Schweppes Citrus Zero", 
                "Schweppes Tônica", "Schweppes Tônica Zero", "Água", 
                "Água com Gás", "Tonica 1,5L", "Citrus 1,5L"
            ],
            "Energéticos": [
                "Red Bull", "Red Bull Sugar Free", "Red Bull Tropical", 
                "Red Bull Melão", "Red Bull Pomelo", "Red Bull Pessêgo", 
                "Red Bull Melancia", "Monster", "Monster Mango Loco"
            ],
            "Bases Alcoolicas": [
                "Bacardi Ouro", "Bacardi Prata", "Smirnoff", "Jack Daniels", 
                "Campari", "Aperol", "Vermouth Rosso", "Absolut", "Tequila Ouro", 
                "Tequila Prata", "Jim Beam", "Licor Fino", "Steinhager", 
                "Chivas 12", "Chivas 15", "Velho Barrero", "Sake", "Vinho", 
                "Malibu", "Martine Dry", "Cachaça Artesanal", "Licor de Menta", 
                "Gordons", "Gordons Rose", "Espumante", "Jagermeister", "Licor 43", "Doka",
                "Bananinha", "Coquinha"
            ],
            "Monin": [
                "Monin Blue Barry", "Monin Morango", "Monin Toranja", 
                "Monin Crawnberry", "Monin Maçâ Verde"
            ],
            "Gelo": [
                "Gelo 3Kg", "Gelo Cubo"
            ]
        };

        let usuarioLogado = null;

        // Função para formatar número decimal
        function formatarDecimal(valor) {
            // Substituir vírgula por ponto e remover caracteres inválidos
            let valorFormatado = valor.replace(',', '.').replace(/[^\d.]/g, '');
            
            // Remover pontos extras, mantendo apenas o primeiro
            const partes = valorFormatado.split('.');
            if (partes.length > 2) {
                valorFormatado = partes[0] + '.' + partes.slice(1).join('');
            }
            
            return valorFormatado;
        }

        // Função para validar número decimal
        function validarNumero(valor) {
            if (valor === '' || valor === '0') return true;
            
            const valorFormatado = formatarDecimal(valor);
            const numero = parseFloat(valorFormatado);
            
            return !isNaN(numero) && numero >= 0;
        }

        // Função para converter string para número
        function converterParaNumero(valor) {
            if (valor === '' || valor === '0') return 0;
            
            const valorFormatado = formatarDecimal(valor);
            const numero = parseFloat(valorFormatado);
            
            return isNaN(numero) ? 0 : numero;
        }

        // Função para formatar exibição do número
        function formatarExibicao(valor) {
            const numero = converterParaNumero(valor);
            if (numero === 0) return '';
            
            // Verificar se é número inteiro ou decimal
            if (Number.isInteger(numero)) {
                return numero.toString();
            } else {
                return numero.toFixed(3).replace(/\.?0+$/, '');
            }
        }

        // Função para preencher a tabela de contagem
        function preencherTabelaContagem() {
            const tabelaBody = document.getElementById('tabelaContagem');
            tabelaBody.innerHTML = '';
            
            // Percorrer todas as categorias e itens
            for (const [categoria, itens] of Object.entries(categoriasItens)) {
                // Adicionar cabeçalho da categoria
                const categoriaRow = document.createElement('tr');
                categoriaRow.className = 'category-header';
                categoriaRow.innerHTML = `<td colspan="2">${categoria}</td>`;
                tabelaBody.appendChild(categoriaRow);
                
                // Adicionar itens da categoria
                for (const item of itens) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item}</td>
                        <td>
                            <input type="text" 
                                   class="quantidade input-decimal" 
                                   data-item="${item}" 
                                   placeholder="0"
                                   oninput="validarInput(this)"
                                   onblur="formatarInput(this)">
                        </td>
                    `;
                    tabelaBody.appendChild(row);
                }
            }
        }

        // Função para validar input em tempo real
        function validarInput(input) {
            const valor = input.value;
            const isValid = validarNumero(valor);
            
            if (isValid) {
                input.classList.remove('input-invalido');
            } else {
                input.classList.add('input-invalido');
            }
        }

        // Função para formatar input quando perde o foco
        function formatarInput(input) {
            const valorFormatado = formatarExibicao(input.value);
            input.value = valorFormatado;
            input.classList.remove('input-invalido');
        }

        // Função para salvar a contagem
        function salvarContagem() {
            // Verificar se o usuário está autenticado
            if (!usuarioLogado) {
                mostrarToast('É necessário fazer login para salvar a contagem', 'warning');
                return;
            }

            // Verificar se há inputs inválidos
            const inputsInvalidos = document.querySelectorAll('.input-invalido');
            if (inputsInvalidos.length > 0) {
                mostrarToast('Existem valores inválidos na contagem. Corrija os campos destacados em vermelho.', 'danger');
                inputsInvalidos[0].focus();
                return;
            }

            const btnSalvar = document.getElementById('btnSalvar');
            const spinner = btnSalvar.querySelector('.spinner-border');
            const icon = btnSalvar.querySelector('.fa-save');
            
            // Mostrar spinner e esconder ícone
            spinner.style.display = 'inline-block';
            icon.style.display = 'none';
            btnSalvar.disabled = true;

            // Coletar dados da contagem
            const contagem = {};
            let totalItens = 0;
            let itensComQuantidade = 0;
            
            document.querySelectorAll('.quantidade').forEach(input => {
                const item = input.getAttribute('data-item');
                const quantidade = converterParaNumero(input.value);
                contagem[item] = quantidade;
                
                if (quantidade > 0) {
                    totalItens++;
                    itensComQuantidade++;
                }
            });

            const timestamp = new Date().getTime();
            const dataHora = new Date().toLocaleString('pt-BR');
            const data = new Date().toLocaleDateString('pt-BR');

            console.log('Salvando contagem:', {
                itens: contagem,
                timestamp: timestamp,
                usuario: usuarioLogado.email,
                totalItens: totalItens,
                itensComQuantidade: itensComQuantidade
            });

            // Salvar no Firebase
            database.ref('contagens').push().set({
                itens: contagem,
                timestamp: timestamp,
                dataHora: dataHora,
                data: data,
                usuario: usuarioLogado.email,
                totalItens: totalItens,
                itensComQuantidade: itensComQuantidade
            })
            .then(() => {
                console.log('Contagem salva com sucesso!');
                mostrarToast('Contagem salva com sucesso!', 'success');
            })
            .catch((error) => {
                console.error('Erro detalhado ao salvar contagem:', error);
                
                let mensagemErro = 'Erro ao salvar contagem: ';
                
                if (error.code === 'PERMISSION_DENIED') {
                    mensagemErro += 'Permissão negada. Verifique:';
                    mensagemErro += '\n1. Se as regras do Firebase estão configuradas corretamente';
                    mensagemErro += '\n2. Se o usuário está autenticado';
                    mensagemErro += '\n3. Se o nó "contagens" existe nas regras';
                } else {
                    mensagemErro += error.message;
                }
                
                mostrarToast(mensagemErro, 'danger');
            })
            .finally(() => {
                // Restaurar botão
                spinner.style.display = 'none';
                icon.style.display = 'inline-block';
                btnSalvar.disabled = false;
            });
        }

        // Função para mostrar notificações toast
        function mostrarToast(mensagem, tipo = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${tipo} border-0`;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.id = toastId;
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${mensagem}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            
            const toast = new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 5000
            });
            
            toast.show();
            
            // Remover o toast do DOM após ser escondido
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        }

        // Função de logout
        function fazerLogout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                auth.signOut().then(() => {
                    usuarioLogado = null;
                    localStorage.removeItem('usuarioLogado');
                    window.location.href = 'index.html';
                });
            }
        }

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            auth.onAuthStateChanged((user) => {
                if (user) {
                    usuarioLogado = user;
                    console.log('Usuário autenticado:', user.email);
                    preencherTabelaContagem();
                } else {
                    console.log('Usuário não autenticado, redirecionando...');
                    window.location.href = 'index.html';
                }
            });
        });

        // Adicionar atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl + Enter para salvar
            if (e.ctrlKey && e.key === 'Enter') {
                salvarContagem();
            }
        });
    </script>
</body>
</html>
