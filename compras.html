<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Compras</title>
    <link rel="icon" href="imagens/icon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .table-header {
            background-color: #343a40;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .category-header {
            background-color: #e9ecef;
            font-weight: bold;
            font-size: 1.1em;
        }
        .table-responsive {
            max-height: 80vh;
            overflow-y: auto;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
        }
        .nav-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .section-title {
            border-left: 5px solid #ffc107;
            padding-left: 10px;
            margin: 20px 0;
        }
        .valor-total {
            background-color: #e7f3ff;
            font-weight: bold;
        }
        .btn-save {
            position: relative;
            overflow: hidden;
        }
        .btn-save .spinner-border {
            width: 1rem;
            height: 1rem;
            display: none;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>
     <!-- Cabeçalho -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand nav-brand" href="#">
                <i class="fas fa-users-cog me-2"></i>Controle de Estoque
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="contagem.html"><i class="fas fa-clipboard-list me-1"></i>Contagem</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="registros.html"><i class="fas fa-history me-1"></i>Registros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="adm_est.html"><i class="fas fa-chart-line me-1"></i>Admin Estoque</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="compras.html"><i class="fas fa-cart-plus me-1"></i>Compras</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tab_compras.html"><i class="fas fa-receipt me-1"></i>Relatório Compras</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="admin.html"><i class="fas fa-users-cog me-1"></i>Admin Usuários</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="fazerLogout()"><i class="fas fa-sign-out-alt me-1"></i>Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="section-title">Registro de Compras</h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Preencha os campos abaixo para registrar novas compras. Apenas os itens com informações preenchidas serão salvos.
                </div>
                
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Itens para Compra</h5>
                            <div>
                                <button class="btn btn-success btn-save" onclick="salvarCompras()" id="btnSalvar">
                                    <i class="fas fa-save me-1"></i>Salvar Compras
                                    <span class="spinner-border spinner-border-sm"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-striped">
                                <thead class="table-header">
                                    <tr>
                                        <th width="25%">Item</th>
                                        <th width="15%">Valor Unitário (R$)</th>
                                        <th width="15%">Quantidade</th>
                                        <th width="20%">Fornecedor</th>
                                        <th width="15%">Valor Total (R$)</th>
                                        <th width="10%">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaCompras">
                                    <!-- Os dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <strong>Total Geral: R$ <span id="totalGeral">0,00</span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container para notificações -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALbn7ZCTfC7u2otwO2Z1kqp2jMHYPpDQk",
            authDomain: "stock-control-a168b.firebaseapp.com",
            databaseURL: "https://stock-control-a168b-default-rtdb.firebaseio.com",
            projectId: "stock-control-a168b",
            storageBucket: "stock-control-a168b.firebasestorage.app",
            messagingSenderId: "200894157109",
            appId: "1:200894157109:web:119ad5ee8432fb8a7b3c7c"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Estrutura completa de itens
        const categoriasItens = {
            "Chopp": [
                "Heineken", "Amstel", "Baden IPA", "Vinho Tinto", "Vinho Rose", 
                "Brahma", "Tiger"
            ],
            "Longneck": [
                "Heiniken Longneck", "Heiniken Zero", "Eisenbahn", "Patagônia", 
                "Skol Beats", "Smirnoff Ice", "Lagunitas", "Becks", "Corona", 
                "Stella", "Stella Gold", "Sol", "Sol Zero", "Budweiser", 
                "Budweiser Zero", "Spaten"
            ],
            "Soft Drinks": [
                "Coca Cola", "Coca Zero", "Fanta Laranja", "Fanta Uva", 
                "Fanta Guaraná", "Schweppes Citrus", "Schweppes Citrus Zero", 
                "Schweppes Tônica", "Schweppes Tônica Zero", "Água", 
                "Água com Gás", "Tonica 1,5L", "Citrus 1,5L"
            ],
            "Energéticos": [
                "Red Bull", "Red Bull Sugar Free", "Red Bull Tropical", 
                "Red Bull Melão", "Red Bull Pomelo", "Red Bull Pessêgo", 
                "Red Bull Melancia", "Monster", "Monster Mango Loco"
            ],
            "Bases Alcoolicas": [
                "Bacardi Ouro", "Bacardi Prata", "Smirnoff", "Jack Daniels", 
                "Campari", "Aperol", "Vermouth Rosso", "Absolut", "Tequila Ouro", 
                "Tequila Prata", "Jim Beam", "Licor Fino", "Steinhager", 
                "Chivas 12", "Chivas 15", "Velho Barrero", "Sake", "Vinho", 
                "Malibu", "Martine Dry", "Cachaça Artesanal", "Licor de Menta", 
                "Gordons", "Gordons Rose", "Espumante", "Jagermeister", "Licor 43"
            ],
            "Monin": [
                "Monin Blue Barry", "Monin Morango", "Monin Toranja", 
                "Monin Crawnberry", "Monin Maçâ Verde"
            ],
            "Gelo": [
                "Gelo 3Kg", "Gelo Cubo"
            ]
        };

        let usuarioLogado = null;

        // Função para preencher a tabela de compras
        function preencherTabelaCompras() {
            const tabelaBody = document.getElementById('tabelaCompras');
            tabelaBody.innerHTML = '';
            
            // Percorrer todas as categorias e itens
            for (const [categoria, itens] of Object.entries(categoriasItens)) {
                // Adicionar cabeçalho da categoria
                const categoriaRow = document.createElement('tr');
                categoriaRow.className = 'category-header';
                categoriaRow.innerHTML = `<td colspan="6">${categoria}</td>`;
                tabelaBody.appendChild(categoriaRow);
                
                // Adicionar itens da categoria
                for (const item of itens) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item}</td>
                        <td>
                            <input type="number" step="0.01" min="0" class="valor-unitario" data-item="${item}" 
                                placeholder="0,00" oninput="calcularValorTotal('${item}')">
                        </td>
                        <td>
                            <input type="number" min="0" class="quantidade" data-item="${item}" 
                                placeholder="0" oninput="calcularValorTotal('${item}')">
                        </td>
                        <td>
                            <input type="text" class="fornecedor" data-item="${item}" 
                                placeholder="Nome do fornecedor">
                        </td>
                        <td>
                            <input type="text" class="valor-total" data-item="${item}" 
                                readonly value="R$ 0,00">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="limparLinha('${item}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    `;
                    tabelaBody.appendChild(row);
                }
            }
        }

        // Função para calcular o valor total de um item
        function calcularValorTotal(item) {
            const valorUnitario = parseFloat(document.querySelector(`.valor-unitario[data-item="${item}"]`).value) || 0;
            const quantidade = parseInt(document.querySelector(`.quantidade[data-item="${item}"]`).value) || 0;
            const valorTotal = valorUnitario * quantidade;
            
            const valorTotalInput = document.querySelector(`.valor-total[data-item="${item}"]`);
            valorTotalInput.value = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
            
            calcularTotalGeral();
        }

        // Função para calcular o total geral
        function calcularTotalGeral() {
            let totalGeral = 0;
            document.querySelectorAll('.valor-total').forEach(input => {
                const valor = parseFloat(input.value.replace('R$ ', '').replace(',', '.')) || 0;
                totalGeral += valor;
            });
            
            document.getElementById('totalGeral').textContent = totalGeral.toFixed(2).replace('.', ',');
        }

        // Função para limpar uma linha
        function limparLinha(item) {
            document.querySelector(`.valor-unitario[data-item="${item}"]`).value = '';
            document.querySelector(`.quantidade[data-item="${item}"]`).value = '';
            document.querySelector(`.fornecedor[data-item="${item}"]`).value = '';
            document.querySelector(`.valor-total[data-item="${item}"]`).value = 'R$ 0,00';
            
            calcularTotalGeral();
        }

        // Função para salvar as compras
        function salvarCompras() {
            if (!usuarioLogado) {
                mostrarToast('É necessário fazer login para salvar as compras', 'warning');
                return;
            }

            const btnSalvar = document.getElementById('btnSalvar');
            const spinner = btnSalvar.querySelector('.spinner-border');
            const icon = btnSalvar.querySelector('.fa-save');
            
            // Mostrar spinner e esconder ícone
            spinner.style.display = 'inline-block';
            icon.style.display = 'none';
            btnSalvar.disabled = true;

            const compras = [];
            const timestamp = new Date().getTime();
            const dataHora = new Date().toLocaleString('pt-BR');

            // Coletar apenas os itens com informações preenchidas
            document.querySelectorAll('.valor-unitario').forEach(input => {
                const item = input.getAttribute('data-item');
                const valorUnitario = parseFloat(input.value) || 0;
                const quantidade = parseInt(document.querySelector(`.quantidade[data-item="${item}"]`).value) || 0;
                const fornecedor = document.querySelector(`.fornecedor[data-item="${item}"]`).value.trim();
                const valorTotal = valorUnitario * quantidade;

                if (valorUnitario > 0 && quantidade > 0 && fornecedor) {
                    compras.push({
                        item: item,
                        valorUnitario: valorUnitario,
                        quantidade: quantidade,
                        fornecedor: fornecedor,
                        valorTotal: valorTotal,
                        timestamp: timestamp,
                        dataHora: dataHora,
                        usuario: usuarioLogado.email
                    });
                }
            });

            if (compras.length === 0) {
                mostrarToast('Nenhum item válido para salvar. Preencha pelo menos um item completamente.', 'warning');
                spinner.style.display = 'none';
                icon.style.display = 'inline-block';
                btnSalvar.disabled = false;
                return;
            }

            // Salvar no Firebase
            const registroRef = database.ref('compras').push();
            registroRef.set({
                compras: compras,
                timestamp: timestamp,
                dataHora: dataHora,
                usuario: usuarioLogado.email,
                totalGeral: compras.reduce((total, compra) => total + compra.valorTotal, 0)
            })
            .then(() => {
                mostrarToast('Compras salvas com sucesso!', 'success');
                // Limpar os campos preenchidos
                compras.forEach(compra => {
                    limparLinha(compra.item);
                });
            })
            .catch((error) => {
                console.error('Erro ao salvar compras:', error);
                mostrarToast('Erro ao salvar compras: ' + error.message, 'danger');
            })
            .finally(() => {
                // Restaurar botão
                spinner.style.display = 'none';
                icon.style.display = 'inline-block';
                btnSalvar.disabled = false;
            });
        }

        // Função para mostrar notificações toast
        function mostrarToast(mensagem, tipo = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${tipo} border-0`;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.id = toastId;
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${mensagem}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            
            const toast = new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 3000
            });
            
            toast.show();
            
            // Remover o toast do DOM após ser escondido
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        }

        // Função de logout
        function fazerLogout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                auth.signOut().then(() => {
                    usuarioLogado = null;
                    localStorage.removeItem('usuarioLogado');
                    window.location.href = 'index.html';
                });
            }
        }

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            auth.onAuthStateChanged((user) => {
                if (user) {
                    usuarioLogado = user;
                    preencherTabelaCompras();
                } else {
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>