<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registros de Contagem</title>
    <link rel="icon" href="imagens/icon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .table-header {
            background-color: #343a40;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .section-title {
            border-left: 5px solid #ffc107;
            padding-left: 10px;
            margin: 20px 0;
        }
        .stats-card {
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .filtro-section {
            background-color: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Cabeçalho -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand nav-brand" href="#">
                <i class="fas fa-history me-2"></i>Controle de Estoque
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="contagem.html"><i class="fas fa-clipboard-list me-1"></i>Contagem</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="registros.html"><i class="fas fa-history me-1"></i>Registros</a>
                    </li>
                   
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html"><i class="fas fa-users-cog me-1"></i>Admin Usuários</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="fazerLogout()"><i class="fas fa-sign-out-alt me-1"></i>Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="section-title">Registros de Contagem</h2>
                
                <div class="filtro-section">
                    <h5>Filtro por Período</h5>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="dataInicio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="dataInicio">
                        </div>
                        <div class="col-md-3">
                            <label for="dataFim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="dataFim">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary" onclick="aplicarFiltro()">
                                <i class="fas fa-filter me-1"></i>Aplicar Filtro
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="limparFiltro()">
                                <i class="fas fa-times me-1"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0" id="tituloRelatorio">Todos os Registros</h5>
                            <div>
                                <button class="btn btn-outline-primary" onclick="exportarParaExcel()" id="btnExportar">
                                    <i class="fas fa-download me-1"></i>Exportar Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-light stats-card">
                                    <div class="card-body text-center">
                                        <h6>Total de Registros</h6>
                                        <h3 id="totalRegistros">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white stats-card">
                                    <div class="card-body text-center">
                                        <h6>Período</h6>
                                        <h5 id="periodoSelecionado">Todos</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white stats-card">
                                    <div class="card-body text-center">
                                        <h6>Última Atualização</h6>
                                        <h5 id="ultimaAtualizacao">-</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-striped">
                                <thead class="table-header">
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Usuário</th>
                                        <th>Total de Itens</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaRegistros">
                                    <!-- Os dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Detalhes da Contagem -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Contagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="detalhesConteudo">
                        <!-- Conteúdo será preenchido via JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container para notificações -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALbn7ZCTfC7u2otwO2Z1kqp2jMHYPpDQk",
            authDomain: "stock-control-a168b.firebaseapp.com",
            databaseURL: "https://stock-control-a168b-default-rtdb.firebaseio.com",
            projectId: "stock-control-a168b",
            storageBucket: "stock-control-a168b.firebasestorage.app",
            messagingSenderId: "200894157109",
            appId: "1:200894157109:web:119ad5ee8432fb8a7b3c7c"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let usuarioLogado = null;
        let todosRegistros = [];
        let registrosFiltrados = [];
        let modalDetalhes = null;

        // Função para carregar todos os registros
        function carregarRegistros() {
            console.log('Carregando registros do Firebase...');
            
            database.ref('contagens').orderByChild('timestamp').once('value')
                .then((snapshot) => {
                    console.log('Dados recebidos:', snapshot.val());
                    todosRegistros = [];
                    snapshot.forEach((childSnapshot) => {
                        const registro = childSnapshot.val();
                        registro.id = childSnapshot.key;
                        todosRegistros.push(registro);
                    });
                    
                    // Ordenar por timestamp (mais recente primeiro)
                    todosRegistros.sort((a, b) => b.timestamp - a.timestamp);
                    
                    registrosFiltrados = [...todosRegistros];
                    exibirRegistros();
                    
                    if (todosRegistros.length > 0) {
                        document.getElementById('ultimaAtualizacao').textContent = 
                            todosRegistros[0].data || new Date(todosRegistros[0].timestamp).toLocaleDateString('pt-BR');
                    }
                })
                .catch((error) => {
                    console.error('Erro ao carregar registros:', error);
                    mostrarToast('Erro ao carregar registros: ' + error.message, 'danger');
                });
        }

        // Função para aplicar filtro
        function aplicarFiltro() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            if (!dataInicio || !dataFim) {
                mostrarToast('Selecione ambas as datas para filtrar', 'warning');
                return;
            }
            
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            fim.setHours(23, 59, 59, 999); // Fim do dia
            
            registrosFiltrados = todosRegistros.filter(registro => {
                const dataRegistro = new Date(registro.timestamp);
                return dataRegistro >= inicio && dataRegistro <= fim;
            });
            
            document.getElementById('tituloRelatorio').textContent = 
                `Registros de ${dataInicio} à ${dataFim}`;
            document.getElementById('periodoSelecionado').textContent = `${dataInicio} a ${dataFim}`;
            
            exibirRegistros();
        }

        // Função para limpar filtro
        function limparFiltro() {
            document.getElementById('dataInicio').value = '';
            document.getElementById('dataFim').value = '';
            registrosFiltrados = [...todosRegistros];
            document.getElementById('tituloRelatorio').textContent = 'Todos os Registros';
            document.getElementById('periodoSelecionado').textContent = 'Todos';
            exibirRegistros();
        }

        // Função para exibir registros na tabela
        function exibirRegistros() {
            const tabelaBody = document.getElementById('tabelaRegistros');
            tabelaBody.innerHTML = '';
            
            registrosFiltrados.forEach(registro => {
                const totalItens = registro.itens ? Object.keys(registro.itens).length : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${registro.data || new Date(registro.timestamp).toLocaleString('pt-BR')}</td>
                    <td>${registro.usuario || 'N/A'}</td>
                    <td>${totalItens}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="verDetalhes('${registro.id}')">
                            <i class="fas fa-eye me-1"></i>Ver Detalhes
                        </button>
                    </td>
                `;
                tabelaBody.appendChild(row);
            });
            
            // Atualizar estatísticas
            document.getElementById('totalRegistros').textContent = registrosFiltrados.length;
            
            // Habilitar/desabilitar botão de exportação
            document.getElementById('btnExportar').disabled = registrosFiltrados.length === 0;
        }

        // Função para ver detalhes de uma contagem
        function verDetalhes(registroId) {
            const registro = todosRegistros.find(r => r.id === registroId);
            if (!registro) return;
            
            const detalhesConteudo = document.getElementById('detalhesConteudo');
            let html = `
                <div class="mb-3">
                    <strong>Data/Hora:</strong> ${registro.data || new Date(registro.timestamp).toLocaleString('pt-BR')}<br>
                    <strong>Usuário:</strong> ${registro.usuario || 'N/A'}<br>
                    <strong>Total de Itens:</strong> ${registro.itens ? Object.keys(registro.itens).length : 0}
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-header">
                            <tr>
                                <th>Item</th>
                                <th>Quantidade</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (registro.itens) {
                for (const [item, quantidade] of Object.entries(registro.itens)) {
                    html += `
                        <tr>
                            <td>${item}</td>
                            <td>${quantidade}</td>
                        </tr>
                    `;
                }
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            detalhesConteudo.innerHTML = html;
            
            if (!modalDetalhes) {
                modalDetalhes = new bootstrap.Modal(document.getElementById('modalDetalhes'));
            }
            modalDetalhes.show();
        }

        // Função para exportar para Excel
        function exportarParaExcel() {
            if (registrosFiltrados.length === 0) {
                mostrarToast('Nenhum dado para exportar', 'warning');
                return;
            }
            
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            let nomeArquivo = 'registros_contagem';
            if (dataInicio && dataFim) {
                nomeArquivo += `_${dataInicio}_a_${dataFim}`;
            } else {
                nomeArquivo += '_todos';
            }
            
            let csvContent = "Registros de Contagem de Estoque";
            if (dataInicio && dataFim) {
                csvContent += ` - Período: ${dataInicio} à ${dataFim}\n`;
            }
            csvContent += `Data de Exportação: ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            
            // Cabeçalho
            csvContent += "Data/Hora;Usuário;Total de Itens\n";
            
            // Dados
            registrosFiltrados.forEach(registro => {
                const totalItens = registro.itens ? Object.keys(registro.itens).length : 0;
                csvContent += `"${registro.data || new Date(registro.timestamp).toLocaleString('pt-BR')}";"${registro.usuario || 'N/A'}";"${totalItens}"\n`;
            });
            
            // Criar e baixar o arquivo
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `${nomeArquivo}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarToast('Dados exportados com sucesso', 'success');
        }

        // Função para mostrar notificações toast
        function mostrarToast(mensagem, tipo = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${tipo} border-0`;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.id = toastId;
            
            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${mensagem}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastEl);
            
            const toast = new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 3000
            });
            
            toast.show();
            
            // Remover o toast do DOM após ser escondido
            toastEl.addEventListener('hidden.bs.toast', function() {
                toastEl.remove();
            });
        }

        // Função de logout
        function fazerLogout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                auth.signOut().then(() => {
                    usuarioLogado = null;
                    localStorage.removeItem('usuarioLogado');
                    window.location.href = 'index.html';
                });
            }
        }

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            auth.onAuthStateChanged((user) => {
                if (user) {
                    usuarioLogado = user;
                    console.log('Usuário autenticado:', user.email);
                    carregarRegistros();
                } else {
                    console.log('Usuário não autenticado, redirecionando...');
                    window.location.href = 'index.html';
                }
            });
            
            // Definir datas padrão (últimos 30 dias)
            const dataFim = new Date();
            const dataInicio = new Date();
            dataInicio.setDate(dataInicio.getDate() - 30);
            
            document.getElementById('dataInicio').value = dataInicio.toISOString().split('T')[0];
            document.getElementById('dataFim').value = dataFim.toISOString().split('T')[0];
        });
    </script>
</body>
</html>